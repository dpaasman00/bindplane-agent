version: 0.0.1
title: Apache Druid
description: Log parser for Apache Druid
parameters:
  - name: enable_broker_logs
    description: Enable to collect Apache Druid broker logs
    type: bool
    default: true
  - name: broker_log_path
    description: Absolute filepath containing Apache druid broker logs. Required if enable_broker_logs is true
    type: "string"
  - name: enable_coordinator_overlord_logs
    description: Enable to collect Apache Druid coordinator and overlord logs
    type: bool
    default: true
  - name: coordinator_overlord_log_path
    description: Absolute filepath containing Apache Druid coordinator and overlord logs. Required if enable_coordinator_overlord_logs is true
    type: "string"
  - name: enable_historical_logs
    description: Enable to collect Apache Druid historical logs
    type: bool
    default: true
  - name: historical_log_path
    description: Absolute filepath containing Apache Druid historical logs. Required if enable_historical_logs is true
    type: "string"
  - name: enable_middle_manager_logs
    description: Enable to collect Apache Druid middle manager logs
    type: bool
    default: true
  - name: middle_manager_log_path
    description: Absolute filepath containing Apache Druid middle manager logs. Required if enable_middle_manager_logs is true
    type: "string"
  - name: enable_router_logs
    description: Enable to collect Apache Druid router logs
    type: bool
    default: true
  - name: router_log_path
    description: Absolute filepath containing Apache Druid router logs. Required if enable_router_logs is true
    type: "string"
  - name: enable_zookeeper_logs
    description: Enable to collect Apache Druid ZooKeeper logs
    type: bool
    default: true
  - name: zookeeper_log_path
    description: Absolute filepath containing Apache Druid ZooKeeper logs. Required if enable_zookeeper_logs is true
    type: "string"
  - name: start_at
    description: At startup, where to start reading logs from the file (`beginning` or `end`)
    type: string
    valid_values:
     - beginning
     - end
    default: end
  # Apache Druid logs do not include a timezone in their timestamps, so we need to set it explicitly.
  - name: timezone
    description: Timezone to use when parsing the timestamp, since the log timestamp does not contain a timezone.
    type: timezone
    default: UTC
  - name: retain_raw_logs
    description: When enabled will preserve the original log message in a `raw_log` key. This will either be in the `body` or `attributes` depending on how `parse_to` is configured.
    type: bool
    default: false
  - name: parse_to
    description: Where to parse structured log parts
    type: string
    supported:
      - body
      - attributes
    default: body
template: |
  receivers:
    {{ if .enable_broker_logs }}
    filelog/broker_logs:
      include:
        - '{{ .broker_log_path }}'
      multiline:
        line_start_pattern: '\d{4}-\d{2}-\d{2}T\d{2}:\d{2}:\d{2},\d{3}'
      start_at: {{ .start_at }}
      attributes:
        log_type: 'druid.broker'
      operators:
        {{ if .retain_raw_logs }}
        - id: save_raw_log
          type: copy
          from: body
          to: attributes.raw_log
        {{ end }}
        - type: regex_parser
          regex: '(?P<timestamp>\d{4}-\d{2}-\d{2}T\d{2}:\d{2}:\d{2},\d{3})\s+(?P<severity>[A-Z]+)\s+(?P<message>\[(?P<source>[\S\s]+)\]\s+(?P<javaClass>[A-Za-z0-9\.$]+)\s+-\s+?[\S\s]+)'
          parse_to: body
          severity:
            parse_from: body.severity
          timestamp:
            parse_from: body.timestamp
            layout: '%FT%T,%L'
            location: {{ .timezone }}
        {{ if and .retain_raw_logs (eq .parse_to "body")}}
        - id: move_raw_log
          type: move
          from: attributes.raw_log
          to: body.raw_log
        {{ end }}
    {{ end }}

    {{ if .enable_coordinator_overlord_logs }}
    filelog/coordinator_overlord_logs:
      include:
        - '{{ .coordinator_overlord_log_path }}'
      multiline:
        line_start_pattern: '\d{4}-\d{2}-\d{2}T\d{2}:\d{2}:\d{2},\d{3}'
      start_at: {{ .start_at }}
      attributes:
        log_type: 'druid.coordinator_overlord'
      operators:
        {{ if .retain_raw_logs }}
        - id: save_raw_log
          type: copy
          from: body
          to: attributes.raw_log
        {{ end }}
        - type: regex_parser
          regex: '(?P<timestamp>\d{4}-\d{2}-\d{2}T\d{2}:\d{2}:\d{2},\d{3})\s+(?P<severity>[A-Z]+)\s+(?P<message>\[(?P<source>[\S\s]+)\]\s+(?P<javaClass>[A-Za-z0-9\.$]+)\s+-\s+?[\S\s]+)'
          parse_to: body
          severity:
            parse_from: body.severity
          timestamp:
            parse_from: body.timestamp
            layout: '%FT%T,%L'
            location: {{ .timezone }}
        {{ if and .retain_raw_logs (eq .parse_to "body")}}
        - id: move_raw_log
          type: move
          from: attributes.raw_log
          to: body.raw_log
        {{ end }}
    {{ end }}

    {{ if .enable_historical_logs }}
    filelog/historical_logs:
      include:
        - '{{ .historical_log_path }}'
      multiline:
        line_start_pattern: '\d{4}-\d{2}-\d{2}T\d{2}:\d{2}:\d{2},\d{3}'
      start_at: {{ .start_at }}
      attributes:
        log_type: 'druid.historical'
      operators:
        {{ if .retain_raw_logs }}
        - id: save_raw_log
          type: copy
          from: body
          to: attributes.raw_log
        {{ end }}
        - type: regex_parser
          regex: '(?P<timestamp>\d{4}-\d{2}-\d{2}T\d{2}:\d{2}:\d{2},\d{3})\s+(?P<severity>[A-Z]+)\s+(?P<message>\[(?P<source>[\S\s]+)\]\s+(?P<javaClass>[A-Za-z0-9\.$]+)\s+-\s+?[\S\s]+)'
          parse_to: body
          severity:
            parse_from: body.severity
          timestamp:
            parse_from: body.timestamp
            layout: '%FT%T,%L'
            location: {{ .timezone }}
        {{ if and .retain_raw_logs (eq .parse_to "body")}}
        - id: move_raw_log
          type: move
          from: attributes.raw_log
          to: body.raw_log
        {{ end }}
    {{ end }}

    {{ if .enable_middle_manager_logs }}
    filelog/middle_manager_logs:
      include:
        - '{{ .middle_manager_log_path }}'
      multiline:
        line_start_pattern: '\d{4}-\d{2}-\d{2}T\d{2}:\d{2}:\d{2},\d{3}'
      start_at: {{ .start_at }}
      attributes:
        log_type: 'druid.middle_manager'
      operators:
        {{ if .retain_raw_logs }}
        - id: save_raw_log
          type: copy
          from: body
          to: attributes.raw_log
        {{ end }}
        - type: regex_parser
          regex: '(?P<timestamp>\d{4}-\d{2}-\d{2}T\d{2}:\d{2}:\d{2},\d{3})\s+(?P<severity>[A-Z]+)\s+(?P<message>\[(?P<source>[\S\s]+)\]\s+(?P<javaClass>[A-Za-z0-9\.$]+)\s+-\s+?[\S\s]+)'
          parse_to: body
          severity:
            parse_from: body.severity
          timestamp:
            parse_from: body.timestamp
            layout: '%FT%T,%L'
            location: {{ .timezone }}
        {{ if and .retain_raw_logs (eq .parse_to "body")}}
        - id: move_raw_log
          type: move
          from: attributes.raw_log
          to: body.raw_log
        {{ end }}
    {{ end }}

    {{ if .enable_router_logs }}
    filelog/router_logs:
      include:
        - '{{ .router_log_path }}'
      multiline:
        line_start_pattern: '\d{4}-\d{2}-\d{2}T\d{2}:\d{2}:\d{2},\d{3}'
      start_at: {{ .start_at }}
      attributes:
        log_type: 'druid.router'
      operators:
        {{ if .retain_raw_logs }}
        - id: save_raw_log
          type: copy
          from: body
          to: attributes.raw_log
        {{ end }}
        - type: regex_parser
          regex: '(?P<timestamp>\d{4}-\d{2}-\d{2}T\d{2}:\d{2}:\d{2},\d{3})\s+(?P<severity>[A-Z]+)\s+(?P<message>\[(?P<source>[\S\s]+)\]\s+(?P<javaClass>[A-Za-z0-9\.$]+)\s+-\s+?[\S\s]+)'
          parse_to: body
          severity:
            parse_from: body.severity
          timestamp:
            parse_from: body.timestamp
            layout: '%FT%T,%L'
            location: {{ .timezone }}
        {{ if and .retain_raw_logs (eq .parse_to "body")}}
        - id: move_raw_log
          type: move
          from: attributes.raw_log
          to: body.raw_log
        {{ end }}
    {{ end }}

    {{ if .enable_zookeeper_logs }}
    filelog/zookeeper_logs:
      include:
        - '{{ .zookeeper_log_path }}'
      multiline:
        line_start_pattern: '\d{4}-\d{2}-\d{2}T\d{2}:\d{2}:\d{2},\d{3}'
      start_at: {{ .start_at }}
      attributes:
        log_type: 'druid.zookeeper'
      operators:
        {{ if .retain_raw_logs }}
        - id: save_raw_log
          type: copy
          from: body
          to: attributes.raw_log
        {{ end }}
        - type: regex_parser
          regex: '(?P<timestamp>\d{4}-\d{2}-\d{2}T\d{2}:\d{2}:\d{2},\d{3})\s+(?P<severity>[A-Z]+)\s+(?P<message>\[(?P<source>[\S\s]+)\]\s+(?P<javaClass>[A-Za-z0-9\.$]+)\s+-\s+?[\S\s]+)'
          parse_to: body
          severity:
            parse_from: body.severity
          timestamp:
            parse_from: body.timestamp
            layout: '%FT%T,%L'
            location: {{ .timezone }}
        {{ if and .retain_raw_logs (eq .parse_to "body")}}
        - id: move_raw_log
          type: move
          from: attributes.raw_log
          to: body.raw_log
        {{ end }}
    {{ end }}

  service:
    pipelines:
      logs:
        receivers:
          {{ if .enable_broker_logs }}
          - filelog/broker_logs
          {{ end }}

          {{ if .enable_coordinator_overlord_logs }}
          - filelog/coordinator_overlord_logs
          {{ end }}

          {{ if .enable_historical_logs }}
          - filelog/historical_logs
          {{ end }}

          {{ if .enable_middle_manager_logs }}
          - filelog/middle_manager_logs
          {{ end }}

          {{ if .enable_router_logs }}
          - filelog/router_logs
          {{ end }}

          {{ if .enable_zookeeper_logs }}
          - filelog/zookeeper_logs
          {{ end }}
